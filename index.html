<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>تفعيل اللعبة</title>
  <style>
    :root{--bg:#1f4fa3;--yellow:#f4c400;--card:#fff;--text:#111;}
    body{margin:0;background:var(--bg);font-family:Arial,sans-serif;color:#fff;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:18px;box-sizing:border-box}
    .wrap{width:min(520px,100%)}
    header{position:relative;padding:10px 0 16px;text-align:center}
    .logo{position:absolute;left:0;top:0;width:60px;height:60px;object-fit:contain}
    h1{margin:0;color:var(--yellow);font-weight:900;font-size:28px}
    .card{background:var(--card);color:var(--text);border-radius:18px;padding:18px;box-shadow:0 10px 22px rgba(0,0,0,.22);text-align:right}
    label{display:block;font-weight:800;margin-bottom:10px}
    input{width:100%;box-sizing:border-box;padding:14px 12px;border-radius:12px;border:1px solid #d7d7d7;outline:none;font-size:16px}
    input:focus{border-color:#1f4fa3}
    .btn{width:100%;margin-top:12px;padding:14px 12px;border-radius:12px;border:0;background:var(--yellow);color:#111;font-weight:900;font-size:16px;cursor:pointer}
    .msg{margin-top:10px;font-size:14px;text-align:center;color:#b00020;display:none;font-weight:800}
    .ok{color:#0b7a2a}
    .hint{margin-top:10px;font-size:12px;color:#444;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img class="logo" src="logo.png" alt="logo">
      <h1>تفعيل اللعبة</h1>
    </header>

    <div class="card">
      <label for="code">أدخل كود اللعبة</label>
      <input id="code" inputmode="latin" autocomplete="one-time-code" placeholder="مثال: SNDQ-XXXX-XXXX-XXXX" />
      <button class="btn" id="go">تفعيل</button>
      <div class="msg" id="msg"></div>
      <div class="hint">بعد التفعيل سيتم ربط الكود بهذا الجهاز</div>
    </div>
  </div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz2O_0So5pCd0PxFdYm8a7R7f0YcLD8el5j-YAveMs93CEJ1CLSnsaUKCty7NjXNt7HCA/exec";

  const codeEl = document.getElementById('code');
  const msgEl  = document.getElementById('msg');

  // إذا سبق تفعيل الجهاز، ندخله مباشرة صفحة التشغيل
  if (localStorage.getItem('ppt_game_ok') === '1' && (localStorage.getItem('ppt_game_code')||'').trim()) {
    location.href = 'start.html?v=' + Date.now();
  }

  function showMsg(t, ok=false){
    msgEl.textContent = t;
    msgEl.style.display='block';
    msgEl.className = 'msg' + (ok ? ' ok' : '');
  }

  function getDeviceKey(){
    let k = localStorage.getItem('ppt_deviceKey');
    if(!k){
      k = 'dev_' + Math.random().toString(16).slice(2) + '_' + Date.now().toString(16);
      localStorage.setItem('ppt_deviceKey', k);
    }
    return k;
  }

  function verifyCode(code){
    msgEl.style.display='none';

    const deviceKey = getDeviceKey();
    const cbName = '__cb_' + Math.random().toString(36).slice(2);

    window[cbName] = (res)=>{
      try{
        delete window[cbName];
        script.remove();

        if(res && res.ok){
          localStorage.setItem('ppt_game_ok', '1');
          localStorage.setItem('ppt_game_code', code);
          showMsg(res.msg || 'تم التفعيل', true);
          setTimeout(()=> location.href = 'start.html?v=' + Date.now(), 350);
        }else{
          localStorage.removeItem('ppt_game_ok');
          localStorage.removeItem('ppt_game_code');
          showMsg((res && res.msg) ? res.msg : 'فشل التفعيل');
        }
      }catch(e){
        showMsg('حدث خطأ غير متوقع');
      }
    };

    const url = SCRIPT_URL
      + '?code=' + encodeURIComponent(code)
      + '&deviceKey=' + encodeURIComponent(deviceKey)
      + '&callback=' + encodeURIComponent(cbName);

    const script = document.createElement('script');
    script.src = url;
    script.onerror = ()=> showMsg('تعذر الاتصال بخدمة التفعيل');
    document.body.appendChild(script);
  }

  function activate(){
    const code = (codeEl.value || '').trim();
    if(!code || code.length < 4){
      showMsg('اكتب كود صحيح');
      return;
    }
    verifyCode(code);
  }

  document.getElementById('go').addEventListener('click', activate);
  codeEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') activate(); });
</script>
</body>
</html>
